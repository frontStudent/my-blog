### 参考
在网上研究该问题时看了b站的一些讲解，都是在只读缓存的前提下讨论的
- https://www.bilibili.com/video/BV1zm421n72M/

知乎这篇文章更为详细，分了只读缓存和读写缓存的情况，而且还额外讨论了无并发情况
- https://www.zhihu.com/question/319817091/answer/2176813916

下面的记录暂时也只是基于只读缓存

### 回到问题本身
先去读缓存再去读数据库，如果缓存没有命中，就去数据库中读取，然后写入缓存，最后返回数据；
如果缓存命中，就直接返回缓存中的数据。

如果只是读取是不会出现数据不一致的情况的，只有进行写操作时才有可能出现不一致

有以下四种双写的策略：
1. 先更新数据库，再删除缓存
2. 先删除缓存，再更新数据库
3. 先更新数据库，再更新缓存
4. 先更新缓存，再更新数据库

其实就是两个需要讨论的地方：
1. 是删除缓存还是更新缓存
2. 是先操作数据库还是先操作缓存

第一点是直接删除缓存而不是更新，因为删除的动作更为简单，更新可能会多余很多不必要的逻辑
那就排除了策略3和4

### 先删除缓存，再更新数据库
删除缓存之后，更新数据库的操作相对慢；此时如果有请求进来命中不了缓存就会查数据库中旧值再写进缓存；此时缓存中就是旧值，数据库中最后会是更新后的值，就出现了数据不一致

在这之后如果有更多请求进来，读到的都是旧值，这就会导致长时间的不一致

#### 设置缓存过期时间 + 延时双删

1. 通过设置缓存过期时间，若发⽣上述情况，则在缓存过期后，读请求仍然可以从DB中读取最新数据并更新缓存，虽然在⼀定时间范围内数据有差异，但可以保证数据的最终⼀致性。 

2. 延时双删: 在线程 A 更新完数据库值以后，让它先 sleep ⼀⼩段时间，确保线程 B 能 够先从数据库读取数据，再把缺失的数据写⼊缓存，然后，线程 A 再进⾏删除。后续，其它线程读取数据时，发现缓存缺失，会从数据库中读取最新值。

### 先更新数据库，再删除缓存
如果线程 A 更新了数据库中的值，但还没来得及删除缓存值，线程 B 就开始读取数据了，那么此时，线程 B 查询缓存时，发现缓存命中，就会直接从缓存中读取旧值。

但虽然也有不一致，依然更推荐这种策略，因为：
1. 不需要等待缓存过期之后才得到一致性，线程B只在第一次查询时读到旧值
2. 先删除缓存值再更新数据库，有可能导致更多的请求因缓存缺失⽽访问数据库，给数据库带来压力
3. 延迟双删的sleep时间不好控制



